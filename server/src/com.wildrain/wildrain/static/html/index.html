<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.2/css/bootstrap-responsive.min.css" >
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="../js/wildrain.js"></script>
		<script src="../js/blockly_compressed.js"></script>
		<script src="../js/blocks_compressed.js"></script>
		<script src="../js/en.js"></script>
		<xml id="toolbox" style="display: none">
			<category name="Colour">
				<block type="colour_blend"></block>
				<block type="colour_picker"></block>
				<block type="colour_random"></block>
				<block type="colour_rgb"></block>
			</category>
			<category name="Loops">
				<block type="controls_repeat"></block>
				<block type="controls_repeat_ext"></block>
				<block type="controls_whileUntil"></block>
				<block type="controls_flow_statements"></block>
				<block type="controls_for"></block>
				<block type="controls_forEach"></block>
			</category>
			<category name="Conditionals">
				<block type="controls_if"></block>
				<block type="controls_if_else"></block>
				<block type="controls_if_elseif"></block>
				<block type="controls_if_if"></block>
			</category>
			<category name="Lists">
				<block type="lists_create_empty"></block>
				<block type="lists_create_with"></block>
				<block type="lists_create_with_container"></block>
				<block type="lists_create_with_item"></block>
				<block type="lists_getIndex"></block>
				<block type="lists_getSublist"></block>
				<block type="lists_indexOf"></block>
				<block type="lists_isEmpty"></block>
				<block type="lists_length"></block>
				<block type="lists_repeat"></block>
				<block type="lists_setIndex"></block>
			</category>
			<category name="Logic">
				<block type="logic_boolean"></block>
				<block type="logic_compare"></block>
				<block type="logic_negate"></block>
				<block type="logic_null"></block>
				<block type="logic_operation"></block>
				<block type="logic_ternary"></block>
			</category>
			<category name="Math">
				<block type="math_arithmetic"></block>
				<block type="math_change"></block>
				<block type="math_constant"></block>
				<block type="math_constrain"></block>
				<block type="math_modulo"></block>
				<block type="math_number"></block>
				<block type="math_number_property"></block>
				<block type="math_on_list"></block>
				<block type="math_random_float"></block>
				<block type="math_random_int"></block>
				<block type="math_round"></block>
				<block type="math_single"></block>
				<block type="math_trig"></block>
			</category>
			<category name="Text">
				<block type="text_append"></block>
				<block type="text_changeCase"></block>
				<block type="text_charAt"></block>
				<block type="text_create_join_container"></block>
				<block type="text_create_join_item"></block>
				<block type="text_getSubstring"></block>
				<block type="text_indexOf"></block>
				<block type="text_isEmpty"></block>
				<block type="text_join"></block>
				<block type="text_length"></block>
				<block type="text_print"></block>
				<block type="text_prompt"></block>
				<block type="text_trim"></block>
			</category>
			<category name="Variables" custom="VARIABLE"></category>
  			<category name="Functions" custom="PROCEDURE"></category>
  		</xml>
		<script src="../lib/codemirror.js"></script>
		<script type="text/javascript" src="../js/javascript_compressed.js"></script>
		<link rel="stylesheet" href="../lib/codemirror.css">
		<script src="../lib/javascript.js"></script>
        <script>
            getApplications("aicd-links", "aicdJson");
			getFlows();
			var codeMirror;
			$(function() {
				var editorElmt = document.getElementById("editor");
				codeMirror = CodeMirror.fromTextArea(editorElmt, {
					value: "var bla = 'bla';",
					mode: "javascript",
					lineWrapping: true,
					lineNumbers: true
				});
				$('#newFlowSubmit').click(function() {
					codeMirror.doc.setValue("");
				});
				$('#saveFlow').click(function() {
					var flow = codeMirror.doc.getValue();
					var app = $('#appSelectDropdown').val();
					var ver = $('#verSelectDropdown').val();
					var event = $('#eventSelectDropdown').val();
					var flowName = $('#newFlowName').val()
					renderAppsSelectors();
					$('#newFlowName').val("");
					$.ajax({
						url: '/saveFlow',
						type: 'POST',
						data: JSON.stringify({'FlowName': flowName, 'Flow': flow, 'ApplicationName': app, 'ApplicationVersion': ver, 'EventName': event}),
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						success: function(d, s, x) { getFlows();},
						error: function(x, s, e) { getFlows();},
						complete: function(x, s) { getFlows();}
					});
				});
				Blockly.inject(document.getElementById('blocklyHolder'),
        			{
						path: './', 
						toolbox: document.getElementById('toolbox')
					});
					function myUpdateFunction() {
    					var code = Blockly.JavaScript.workspaceToCode();
    					document.getElementById('generatedCode').value = code;
  					}
  					Blockly.addChangeListener(myUpdateFunction);
			});
        </script>
    </head>
    <body>
        <div class="container-fluid">
            <div class="page-header"><h2>WildRain</h2></div>
            <div class="tabbable">
                <ul class="nav nav-tabs" data-tabs="tabs">
                    <li><a href="#aicds" data-toggle="tab">AICDs</a></li>
                    <li><a href="#flows" data-toggle="tab">Flows</a></li>
					<li class="active"><a href="#blockly" data-toggle="tab">Blockly</a></li>
					<li><a href="#generated" data-toggle="tab">Generated Code</a></li>
                </ul>
                <div class="tab-content">
                    <div id="aicds" class="tab-pane">
                        <div class="container-fluid">
                            <div class="row-fluid">
                                <div class="span2">
                                    Choose an AICD to upload: 
                                </div>
                                <div class="span8">
                                    <input id="fileupload" type="file" name="aicd">
                                </div>
                            </div>
                            <div class="row-fluid">
                                <div class="container-fluid">
                                    <div class="span4" id="aicd-links">
                                    </div>
                                    <div class="span8" id="aicdJson">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="flows" class="tab-pane">
                        <div class="container-fluid">
							<div class="span4" id="flowsLinks">
							</div>
							<div class="span8">
								<div class="container-fluid">
									<div class="row-fluid">
										<div class="span4"><div id="appSelect"></div></div>
										<div class="span4"><div id="verSelect"></div></div>
										<div class="span4"><div id="eventSelect"></div></div>
									</div>
									<div class="row-fluid">
										<div class="span4"><input type="text" id="newFlowName"></div>
										<div class="span2"><button type="button" id="newFlowSubmit">New Flow!</button></div>
									</div>
								</div>
								<div class="container-fluid">
									<div class="row-fluid">
										<button type="button" id="saveFlow">Save</button>
										<br />
									</div>
									<div class="row-fluid">
										<textarea id="editor"></textarea>
									</div>
								</div>
							</div>
                        </div>
                    </div>
					<div id="blockly" class="tab-pane active">
						<div id="blocklyHolder"></div>
					</div>                
					<div id="generated" class="tab-pane">
						<textarea id="generatedCode" style="resize: none; width: 600px; height: 500px;" readonly>
					</div>
					</div>
            </div>
            <div id="footer"></div>
        </div>
    </body>
    
</html>
